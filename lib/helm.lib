
init_bash_module_helm() {
    use_module render
    unset_vars+=" helm_command helm_value_files helm_charts"
}

add_optional_helm_values_file() {
    if [[ -f $1 ]]; then
        helm_value_files+=("$1")
    fi
}

init_helm_vars() {
    local parent_dir=$(dirname "$karmah_dir")
    add_optional_helm_values_file "$parent_dir/values*${appname}.yaml"
    add_optional_helm_values_file "$common_dir/values*${appname}.yaml"
    add_optional_helm_values_file "$karmah_dir/values*${appname}-${env}.yaml"
}

render_helm() {
    : ${helm_command:="helm template --namespace ${namespace}"} # TODO: --create-namespace does not create yaml for namespace
    helm_release=$appname # this is probably not really used with helm template
    local f
    for f in ${helm_value_files[@]}; do helm_command+=" -f ${f}"; done
    helm_command+=" $helm_release"
    used_files="${helm_value_files[@]}"
    for ch in ${helm_charts//,/ }; do
        local chart=${ch//@*}
        if [[ $ch == $chart ]]; then
            used_files+=" $ch"
            verbose_pipe split_into_files "$helm_command $ch"
        else
            local repo=${ch//*@}
            verbose_pipe split_into_files "$helm_command --repo $repo $chart --version $chart_version"
        fi
    done
}

apply_update_helm() {
    local f=${helm_value_files[-1]}
    verbose applying update "$1" to "$f"
    case "$1" in
        yq:*)
            local expr="${1#yq:}"
            expr=${expr//=/=\"}\"  # add quotes around =...
            verbose_cmd yq -i "${expr}" "$f"
        ;;
        *)
            echo unknown update "$1";
            exit 1
        ;;
    esac
}
