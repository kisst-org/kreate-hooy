
init_bash_module_helm() {
    use_module render
    global_vars+=" helm_command helm_value_files helm_charts"
    global_arrays+="helm_update_version_path helm_update_replicas_path"
}

add_optional_helm_values_file() {
    local f=($1)
    if [[ -f $f ]]; then
        debug adding values file $f
        helm_value_files+=("$f")
    else
        debug skipping values file $f
    fi
}

init_helm_vars() {
    local parent_dir=$(dirname "$karmah_dir")
    add_optional_helm_values_file "$common_dir/values*.yaml"
    add_optional_helm_values_file "$karmah_dir/values*.yaml"
}

render_helm() {
    : ${helm_command:="helm template --namespace ${namespace}"} # TODO: --create-namespace does not create yaml for namespace
    helm_release=$(basename $target) # this is probably not really used with helm template
    local f
    for f in ${helm_value_files[@]}; do helm_command+=" -f ${f}"; done
    helm_command+=" $helm_release"
    used_files="${helm_value_files[@]}"
    for ch in ${helm_charts//,/ }; do
        local chart=${ch//@*}
        if [[ $ch == $chart ]]; then
            used_files+=" $ch"
            verbose_pipe split_into_files "$helm_command $ch"
        else
            local repo=${ch//*@}
            verbose_pipe split_into_files "$helm_command --repo $repo $chart --version $chart_version"
        fi
    done
}

apply_update_helm() {
    local f=${helm_value_files[-1]}
    verbose applying update "$1" to "$f"
    case "$1" in
        yq:*)
            local expr="${1#yq:}"
            expr=${expr//=/=\"}\"  # add quotes around =...
            verbose_cmd yq -i "${expr}" "$f"
        ;;
        *)
            echo unknown update "$1";
            exit 1
        ;;
    esac
}

update_version_helm() {
    local res
    local val_file=($karmah_dir/values*.yaml)
    for res in $(calc_resource_names); do
        verbose updating $res version to $update_version
        verbose_cmd yq -i "${helm_update_version_path[$res]}=\"$update_version\"" $val_file
    done
}

update_replicas_helm() {
    local res
    local val_file=($karmah_dir/values*.yaml)
    for res in $(calc_resource_names); do
        local repl=${kube_replicas:-default}
        if [[ $repl == default ]]; then
            repl=${kube_default_replicas[$res]}
        fi
        verbose updating $res replicas to $repl
        verbose_cmd yq -i "${helm_update_replicas_path[$res]}=\"$repl\"" $val_file
    done
}
