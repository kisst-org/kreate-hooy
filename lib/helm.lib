
init_helm_vars() {
    local def_file_dir=$(dirname ${def_file})
    local parent_dir=$(dirname "$def_file_dir")

    helm_value_files=("helm/env-value-files/values-env-${env}.yaml")
    helm_value_files+=("$parent_dir/values*${appname}.yaml")
    helm_value_files+=("$def_file_dir/values*${appname}-${env}.yaml")

    helm_command="helm template --namespace ${namespace}" # TODO: --create-namespace does not create yaml for namespace
    appdef_vars+="helm_command helm_value_files helm_charts"
}

render_helm() {
    helm_release=$appname # this is probably not really used with helm template
    local f
    for f in ${helm_value_files[@]}; do helm_command+=" -f ${f}"; done
    helm_command+=" $helm_release"
    used_files="${helm_value_files[@]}"
    for ch in ${helm_charts//,/ }; do
        local chart=${ch//@*}
        if [[ $ch == $chart ]]; then
            used_files+=" $ch"
            verbose_pipe split_into_files "$helm_command $ch"
        else
            local repo=${ch//*@}
            verbose_pipe split_into_files "$helm_command --repo $repo $chart --version $chart_version"
        fi
    done
}

apply_update_helm() {
    local f=${helm_value_files[-1]}
    verbose applying update "$1" to "$f"
    case "$1" in
        yq:*)
            local expr="${1#yq:}"
            expr=${expr//=/=\"}\"  # add quotes around =...
            verbose_cmd yq -i "${expr}" "$f"
        ;;
        *)
            echo unknown update "$1";
            exit 1
        ;;
    esac
}
