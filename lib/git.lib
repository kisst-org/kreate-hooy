#####################################
# git module


init_module_git() {
    use_module argparse
    declare -g used_files=""
    aliases[deploy]="run:git-pull,update,render,kube-diff,git-diff,ask,git-add,git-commit to:deployed/manifests"
    declare -g git_pulled=false
    add_command git-diff "shows the changes to source and rendered manifests with git"
    add_command git-add "adds the changes to source and rendered manifests to git, for committing"
    add_command git-commit "commits the changes to source and rendered manifests to git"
}

run_command_git-diff() { forall-appenvs git-diff; }
run_command_git-add() { forall-appenvs git-add; }
run_command_git-commit() { forall-appenvs git-commit; }

run_action_ask() {
    local answer
    read -p "do you want to continue?" answer
}

run_action_git-pull() {
    verbose_cmd git pull
}

run_action_git-diff() {
    run_action_render
    info git-diff ${env} ${appname} to ${output_dir}
    if $(log_is_verbose); then
        verbose_cmd git diff -- ${used_files} ${output_dir} || true
    else
        verbose_cmd git diff -- ${used_files} ${output_dir} | grep -E '^[+-] |^---' || true
    fi
}

run_action_git-add() {
    run_action_render
    info git-add ${env} ${appname} to ${output_dir}
    verbose_cmd git add "${used_files} ${output_dir}"
}

run_action_git-status() {
    run_action_render
    git status
}


run_action_git-commit() {
    run_action_git-add
    info git commit -m "${action} of ${appname} on ${env}" "${used_files} ${output_dir}"
}
