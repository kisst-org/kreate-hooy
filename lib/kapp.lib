#####################################
# kube module

init_module_kapp() {
    use_module argparse
    declare -Ag kapp_options
    add_command install-kapp "install the tool kapp from carvel"
    add_command kapp-plan "show what resources will be updated"
    add_command kapp-diff "show what resources will be updated, including detailed diffs"
    add_command kapp-deploy "deploy the application with kapp"
}

run_command_kapp-diff() { forall-appenvs kapp-diff; }
run_command_kapp-plan() { forall-appenvs kapp-plan; }
run_command_kapp-deploy() { forall-appenvs kapp-deploy; }

run_command_install-kapp() {
    if [ -x "$(command -v kapp)" ]; then
        info kapp already installed
        #return 0
    fi
    info Installing kapp...
    local binary_type=linux-amd64
    local version=v0.64.2
    local dst_dir=~/.local/bin

    if (( $log_level >= $log_level_verbose )); then
        verbose_cmd curl    -L https://github.com/carvel-dev/kapp/releases/download/${version}/kapp-${binary_type} -o ${dst_dir}/kapp
    else
        verbose_cmd curl -s -L https://github.com/carvel-dev/kapp/releases/download/${version}/kapp-${binary_type} -o ${dst_dir}/kapp
    fi
    chmod +x ${dst_dir}/kapp
    verbose Installed ${dst_dir}/kapp ${version}
}


run_action_kapp-diff() {
    run_action_render
    verbose_cmd kapp deploy ${kapp_options[$env]} --diff-run --diff-changes -a ${appname} -f "${output_dir}"
}

run_action_kapp-plan() {
    run_action_render
    verbose_cmd kapp deploy ${kapp_options[$env]} --diff-run -a ${appname} -f "${output_dir}"
}

run_action_kapp-deploy() {
    run_action_render
    verbose_cmd kapp deploy ${kapp_options[$env]} -a ${appname} -f "${output_dir}"
}
